name: Release Single Package

on:
  workflow_dispatch:
    inputs:
      package:
        description: Name of the Rush package to release
        required: true
        type: choice
        options:
          - '@vielzeug/deposit'
          - '@vielzeug/fetchit'
          - '@vielzeug/formit'
          - '@vielzeug/i18nit'
          - '@vielzeug/logit'
          - '@vielzeug/permit'
          - '@vielzeug/toolkit'
          - '@vielzeug/validit'
      bump:
        description: 'Version bump (only used if no change files exist)'
        required: true
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'
          scope: '@vielzeug'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.2

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Rush cache
        uses: actions/cache@v4
        with:
          path: |
            common/temp/install-run
            common/temp/pnpm-store
            ~/.rush
          key: ${{ runner.os }}-rush-${{ hashFiles('rush.json', 'pnpm-lock.yaml', 'common/config/rush/pnpm-config.json') }}
          restore-keys: |
            ${{ runner.os }}-rush-

      - name: Setup build cache
        uses: actions/cache@v4
        with:
          path: |
            **/dist
            **/node_modules/.cache
          key: ${{ runner.os }}-build-${{ hashFiles('**/package.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('**/package.json') }}-
            ${{ runner.os }}-build-

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rush Install
        run: node common/scripts/install-run-rush.js install

      - name: Build all packages
        run: node common/scripts/install-run-rush.js build --verbose

      - name: Get package info
        id: package-info
        run: |
          PACKAGE_FOLDER=$(node -e "const rush = require('./rush.json'); const project = rush.projects.find(p => p.packageName === '${{ inputs.package }}'); console.log(project.projectFolder);")
          OLD_VERSION=$(node -e "console.log(require('./${PACKAGE_FOLDER}/package.json').version)")
          
          # Check npm version
          NPM_VERSION=$(npm view ${{ inputs.package }} version 2>/dev/null || echo "0.0.0")
          
          echo "folder=$PACKAGE_FOLDER" >> $GITHUB_OUTPUT
          echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "npm-version=$NPM_VERSION" >> $GITHUB_OUTPUT
          
          echo "üì¶ Package: ${{ inputs.package }}"
          echo "üìÇ Folder: ${PACKAGE_FOLDER}"
          echo "üìã Local version: ${OLD_VERSION}"
          echo "üìã npm version: ${NPM_VERSION}"
          
          # Compare versions
          if [ "$OLD_VERSION" = "$NPM_VERSION" ]; then
            echo "‚ö†Ô∏è  Local version matches npm version"
            echo "   A version bump will be required to release"
          elif [ "$NPM_VERSION" = "0.0.0" ]; then
            echo "‚úÖ Package not yet published to npm"
          else
            echo "‚ÑπÔ∏è  Local and npm versions differ"
          fi

      - name: Check for existing change files
        id: check-changes
        run: |
          PACKAGE_SLUG=$(echo "${{ inputs.package }}" | cut -d'/' -f2)
          CHANGE_DIR="common/changes/@vielzeug/${PACKAGE_SLUG}"
          
          # Check if there are any existing change files
          if [ -d "${CHANGE_DIR}" ] && [ -n "$(ls -A ${CHANGE_DIR}/*.json 2>/dev/null)" ]; then
            CHANGE_COUNT=$(ls -1 ${CHANGE_DIR}/*.json 2>/dev/null | wc -l)
            echo "has-changes=true" >> $GITHUB_OUTPUT
            
            # Detect the highest bump type from existing change files
            # Priority: major > minor > patch
            DETECTED_BUMP="patch"
            
            for file in ${CHANGE_DIR}/*.json; do
              # Extract type from each change file
              TYPE=$(node -e "
                try {
                  const data = require('${file}');
                  const changes = data.changes || [];
                  const types = changes.map(c => c.type).filter(Boolean);
                  console.log(types[0] || 'patch');
                } catch (e) {
                  console.log('patch');
                }
              ")
              
              # Update to highest priority bump type
              if [ "$TYPE" = "major" ]; then
                DETECTED_BUMP="major"
              elif [ "$TYPE" = "minor" ] && [ "$DETECTED_BUMP" != "major" ]; then
                DETECTED_BUMP="minor"
              fi
            done
            
            echo "bump-type=$DETECTED_BUMP" >> $GITHUB_OUTPUT
            echo "‚úÖ Found ${CHANGE_COUNT} existing change file(s) for ${{ inputs.package }}"
            echo "üìã Detected bump type: $DETECTED_BUMP (from change files)"
            echo "‚ÑπÔ∏è  Manual bump input '${{ inputs.bump }}' will be ignored"
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "bump-type=${{ inputs.bump }}" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No existing change files found for ${{ inputs.package }}"
            echo "üìã Using manual bump type: ${{ inputs.bump }}"
          fi

      - name: Create change file if none exists
        if: steps.check-changes.outputs.has-changes == 'false'
        run: |
          PACKAGE_SLUG=$(echo "${{ inputs.package }}" | cut -d'/' -f2)
          CHANGE_DIR="common/changes/@vielzeug/${PACKAGE_SLUG}"
          mkdir -p "${CHANGE_DIR}"
          
          BUMP_TYPE="${{ steps.check-changes.outputs.bump-type }}"
          CURRENT_VERSION="${{ steps.package-info.outputs.old-version }}"
          
          # Calculate the next version based on bump type
          NEXT_VERSION=$(node -e "
            const current = '$CURRENT_VERSION';
            const bump = '$BUMP_TYPE';
            const parts = current.split('.').map(Number);
            
            if (bump === 'major') {
              parts[0]++;
              parts[1] = 0;
              parts[2] = 0;
            } else if (bump === 'minor') {
              parts[1]++;
              parts[2] = 0;
            } else {
              parts[2]++;
            }
            
            console.log(parts.join('.'));
          ")
          
          echo "üìã Current version: ${CURRENT_VERSION}"
          echo "üìã Bump type: ${BUMP_TYPE}"
          echo "üìã Next version: ${NEXT_VERSION}"
          
          # Create a rush change file for this release
          cat > "${CHANGE_DIR}/release_$(date +%Y-%m-%d-%H-%M-%S).json" << EOF
          {
            "changes": [
              {
                "packageName": "${{ inputs.package }}",
                "comment": "Release version ${NEXT_VERSION} (${BUMP_TYPE} bump from ${CURRENT_VERSION})",
                "type": "${BUMP_TYPE}"
              }
            ],
            "packageName": "${{ inputs.package }}",
            "email": "github-actions[bot]@users.noreply.github.com"
          }
          EOF
          
          echo "‚úÖ Created temporary change file for ${{ inputs.package }}"
          echo "   This will bump version from ${CURRENT_VERSION} to ${NEXT_VERSION}"

      - name: Verify only selected package will be released
        run: |
          PACKAGE_SLUG=$(echo "${{ inputs.package }}" | cut -d'/' -f2)
          CHANGE_DIR="common/changes/@vielzeug/${PACKAGE_SLUG}"
          
          echo "üìã Release Plan:"
          echo "  Package: ${{ inputs.package }}"
          echo "  Change files directory: ${CHANGE_DIR}"
          
          if [ -d "${CHANGE_DIR}" ] && [ -n "$(ls -A ${CHANGE_DIR}/*.json 2>/dev/null)" ]; then
            echo "  Change files found: $(ls -1 ${CHANGE_DIR}/*.json 2>/dev/null | wc -l)"
          else
            echo "  Change files found: 0 (will create temporary change file)"
          fi
          
          # Check for other packages with changes
          OTHER_CHANGES=""
          for dir in common/changes/@vielzeug/*/; do
            PKG_NAME=$(basename "$dir")
            if [ "$PKG_NAME" != "$PACKAGE_SLUG" ] && [ -d "$dir" ] && [ -n "$(ls -A ${dir}*.json 2>/dev/null)" ]; then
              COUNT=$(ls -1 ${dir}*.json 2>/dev/null | wc -l | tr -d ' ')
              OTHER_CHANGES="${OTHER_CHANGES}@vielzeug/${PKG_NAME} (${COUNT} changes) "
            fi
          done
          
          if [ -n "$OTHER_CHANGES" ]; then
            echo "‚ö†Ô∏è  Note: Other packages have pending changes but will NOT be released:"
            echo "  ${OTHER_CHANGES}"
            echo "  Use 'Release All Packages' workflow to release multiple packages at once."
          else
            echo "‚úÖ No other packages have pending changes."
          fi

      - name: Apply version bump and process changelogs with Rush
        run: |
          PACKAGE_SLUG=$(echo "${{ inputs.package }}" | cut -d'/' -f2)
          CHANGE_DIR="common/changes/@vielzeug/${PACKAGE_SLUG}"
          
          # Temporarily move other packages' change files out of the way
          # so Rush only processes the selected package
          mkdir -p /tmp/other-changes
          
          for dir in common/changes/@vielzeug/*/; do
            PKG_NAME=$(basename "$dir")
            if [ "$PKG_NAME" != "$PACKAGE_SLUG" ] && [ -d "$dir" ]; then
              if [ -n "$(ls -A ${dir}*.json 2>/dev/null)" ]; then
                echo "üì¶ Temporarily moving change files for @vielzeug/${PKG_NAME}"
                mv "${dir}"*.json /tmp/other-changes/ 2>/dev/null || true
              fi
            fi
          done
          
          # Rush publish --apply will now only process the selected package's changes
          # - Update package.json version based on change type
          # - Generate/update CHANGELOG.md and CHANGELOG.json
          # - Delete processed change files for this package only
          # - Commit changes if --target-branch is specified
          node common/scripts/install-run-rush.js publish --apply --target-branch main --add-commit-details --include-all
          
          # Restore other packages' change files
          if [ -n "$(ls -A /tmp/other-changes/*.json 2>/dev/null)" ]; then
            echo "üì¶ Restoring change files for other packages"
            for file in /tmp/other-changes/*.json; do
              FILENAME=$(basename "$file")
              # Extract package name from change file to restore to correct directory
              PKG=$(node -e "try { const data = require('${file}'); console.log(data.packageName || ''); } catch(e) { console.log(''); }")
              if [ -n "$PKG" ]; then
                PKG_SLUG=$(echo "$PKG" | cut -d'/' -f2)
                TARGET_DIR="common/changes/@vielzeug/${PKG_SLUG}"
                mkdir -p "${TARGET_DIR}"
                mv "${file}" "${TARGET_DIR}/"
                echo "  Restored ${FILENAME} to ${TARGET_DIR}"
              fi
            done
            
            # Commit the restored change files back
            git add common/changes/
            if ! git diff --cached --quiet; then
              git commit -m "chore: restore change files for other packages after releasing ${{ inputs.package }}"
              git push origin main
            fi
          fi

      - name: Get new version
        id: version
        run: |
          NEW_VERSION=$(node -e "console.log(require('./${{ steps.package-info.outputs.folder }}/package.json').version)")
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Version bumped from ${{ steps.package-info.outputs.old-version }} to $NEW_VERSION"

      - name: Validate version is new
        run: |
          OLD_VERSION="${{ steps.package-info.outputs.old-version }}"
          NEW_VERSION="${{ steps.version.outputs.new-version }}"
          NPM_VERSION="${{ steps.package-info.outputs.npm-version }}"
          
          echo "üìä Version Check:"
          echo "   Local (before): $OLD_VERSION"
          echo "   Local (after):  $NEW_VERSION"
          echo "   npm:            $NPM_VERSION"
          
          # Check 1: Verify version was bumped from local
          if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
            echo ""
            echo "‚ùå Error: Version was not bumped!"
            echo ""
            echo "The version in package.json is still $OLD_VERSION"
            echo "This means Rush did not process the change file correctly."
            echo ""
            echo "Possible causes:"
            echo "  1. Change file format is incorrect"
            echo "  2. Rush publish did not run successfully"
            echo "  3. Git already had the version committed"
            echo ""
            exit 1
          fi
          
          # Check 2: Verify new version is different from npm
          if [ "$NPM_VERSION" != "0.0.0" ]; then
            # Simple version comparison using Node
            COMPARE_RESULT=$(node -e "
              function compareVersions(v1, v2) {
                const parts1 = v1.split('.').map(Number);
                const parts2 = v2.split('.').map(Number);
                
                for (let i = 0; i < 3; i++) {
                  if (parts1[i] > parts2[i]) return 1;
                  if (parts1[i] < parts2[i]) return -1;
                }
                return 0;
              }
              
              console.log(compareVersions('$NEW_VERSION', '$NPM_VERSION'));
            ")
            
            if [ "$COMPARE_RESULT" = "-1" ]; then
              echo ""
              echo "‚ùå Error: New version is LOWER than npm version!"
              echo ""
              echo "   New version: $NEW_VERSION"
              echo "   npm version: $NPM_VERSION"
              echo ""
              echo "Cannot publish an older version to npm."
              exit 1
            elif [ "$COMPARE_RESULT" = "0" ]; then
              echo ""
              echo "‚ö†Ô∏è  Warning: Version $NEW_VERSION already exists on npm"
              echo ""
              echo "npm will reject publishing the same version."
              echo "This workflow will continue but npm publish will likely fail."
              echo ""
            else
              echo ""
              echo "‚úÖ Version validation passed!"
              echo "   Bump: $OLD_VERSION ‚Üí $NEW_VERSION"
              echo "   npm will be updated: $NPM_VERSION ‚Üí $NEW_VERSION"
            fi
          else
            echo ""
            echo "‚úÖ First publication of this package"
            echo "   Version: $NEW_VERSION"
          fi

      - name: Tag release
        run: |
          TAG_NAME="${{ inputs.package }}@${{ steps.version.outputs.new-version }}"
          
          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag $TAG_NAME already exists"
            echo "üîÑ Deleting existing tag locally and remotely..."
            git tag -d "$TAG_NAME" || true
            git push origin ":refs/tags/$TAG_NAME" || true
            echo "‚úÖ Old tag deleted"
          fi
          
          # Create new tag
          echo "üè∑Ô∏è  Creating tag $TAG_NAME"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          echo "‚úÖ Tag created and pushed"

      - name: Publish to npm
        working-directory: ${{ steps.package-info.outputs.folder }}
        run: |
          # Pack the package to create a tarball
          # This ensures only files specified in "files" field are included
          echo "üì¶ Packing package..."
          TARBALL=$(npm pack --json | node -e "const data = JSON.parse(require('fs').readFileSync(0)); console.log(data[0].filename);")
          
          echo "üì¶ Tarball created: ${TARBALL}"
          
          # Verify tarball contents
          echo "üìã Tarball contents:"
          tar -tzf "${TARBALL}" | head -20
          
          # Publish the tarball
          echo "üöÄ Publishing to npm..."
          npm publish "${TARBALL}" --access public
          
          # Clean up tarball
          rm -f "${TARBALL}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify npm publication
        run: |
          echo "Waiting 10 seconds for npm to update..."
          sleep 10
          
          NPM_VERSION=$(npm view ${{ inputs.package }} version 2>/dev/null || echo "not-found")
          EXPECTED_VERSION="${{ steps.version.outputs.new-version }}"
          
          if [ "$NPM_VERSION" = "$EXPECTED_VERSION" ]; then
            echo "‚úÖ Successfully published ${{ inputs.package }}@$EXPECTED_VERSION to npm"
          else
            echo "‚ö†Ô∏è  Warning: npm shows version $NPM_VERSION, expected $EXPECTED_VERSION"
            echo "This might be a propagation delay. Check https://www.npmjs.com/package/${{ inputs.package }}"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.package }}@${{ steps.version.outputs.new-version }}"
          name: "${{ inputs.package }} v${{ steps.version.outputs.new-version }}"
          body: |
            ## ${{ inputs.package }} v${{ steps.version.outputs.new-version }}
            
            ### Installation
            
            ```bash
            npm install ${{ inputs.package }}@${{ steps.version.outputs.new-version }}
            ```
            
            ### Links
            
            - üì¶ [npm package](https://www.npmjs.com/package/${{ inputs.package }}/v/${{ steps.version.outputs.new-version }})
            - üìã [CHANGELOG](${{ github.server_url }}/${{ github.repository }}/blob/${{ inputs.package }}@${{ steps.version.outputs.new-version }}/${{ steps.package-info.outputs.folder }}/CHANGELOG.md)
          draft: false
          prerelease: false
          generate_release_notes: true


