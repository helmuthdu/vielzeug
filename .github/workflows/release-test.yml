name: Test Release Package (Dry Run)

on:
  workflow_dispatch:
    inputs:
      package:
        description: Name of the Rush package to release
        required: true
        type: choice
        options:
          - '@vielzeug/toolkit'
          - '@vielzeug/deposit'
          - '@vielzeug/fetchit'
          - '@vielzeug/logit'
          - '@vielzeug/permit'
      bump:
        description: Version bump (patch|minor|major)
        required: true
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  release-test:
    runs-on: ubuntu-latest
    outputs:
      new-version: ${{ steps.version.outputs.new-version }}
      package-name: ${{ steps.package-info.outputs.package-name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.2

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rush Install
        run: node common/scripts/install-run-rush.js install

      - name: Build all dependencies
        run: node common/scripts/install-run-rush.js build --to ${{ inputs.package }} --verbose

      - name: Get package folder
        id: package-info
        run: |
          PACKAGE_FOLDER=$(node -e "const rush = require('./rush.json'); const project = rush.projects.find(p => p.packageName === '${{ inputs.package }}'); console.log(project.projectFolder);")
          echo "folder=$PACKAGE_FOLDER" >> $GITHUB_OUTPUT
          echo "package-name=${{ inputs.package }}" >> $GITHUB_OUTPUT
          echo "::notice::Package folder: $PACKAGE_FOLDER"

      - name: Bump version (dry run)
        id: version
        working-directory: ${{ steps.package-info.outputs.folder }}
        run: |
          OLD_VERSION=$(node -e "console.log(require('./package.json').version)")
          npm version ${{ inputs.bump }} --no-git-tag-version
          NEW_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "::notice::Would bump version from $OLD_VERSION to $NEW_VERSION"

      - name: Update CHANGELOG (dry run)
        working-directory: ${{ steps.package-info.outputs.folder }}
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "::notice::Created new CHANGELOG.md"
          fi
          
          DATE=$(date +%Y-%m-%d)
          NEW_VERSION="${{ steps.version.outputs.new-version }}"
          
          # Create temp file with new entry
          echo "## [$NEW_VERSION] - $DATE" > temp_changelog.md
          echo "" >> temp_changelog.md
          echo "### Changes" >> temp_changelog.md
          echo "" >> temp_changelog.md
          echo "- Release version $NEW_VERSION (TEST RUN)" >> temp_changelog.md
          echo "" >> temp_changelog.md
          
          # Append existing changelog (skip first line if it's just "# Changelog")
          tail -n +2 CHANGELOG.md >> temp_changelog.md
          
          # Add header back
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          cat temp_changelog.md >> CHANGELOG.md
          rm temp_changelog.md
          
          echo "::notice::Updated CHANGELOG.md"

      - name: Rebuild package
        run: node common/scripts/install-run-rush.js build --to ${{ inputs.package }} --verbose

      - name: Create tarball
        id: pack
        working-directory: ${{ steps.package-info.outputs.folder }}
        run: |
          npm pack
          TARBALL=$(ls *.tgz)
          echo "tarball=$TARBALL" >> $GITHUB_OUTPUT
          echo "tarball-path=${{ steps.package-info.outputs.folder }}/$TARBALL" >> $GITHUB_OUTPUT
          echo "::notice::Created tarball: $TARBALL"
          
          # Show tarball contents
          echo "::group::Tarball contents"
          tar -tzf $TARBALL | head -20
          echo "::endgroup::"

      - name: Show what would be committed
        run: |
          echo "::group::Files that would be committed"
          git status
          git diff ${{ steps.package-info.outputs.folder }}/package.json
          git diff ${{ steps.package-info.outputs.folder }}/CHANGELOG.md
          echo "::endgroup::"
          
          echo "::notice::Tag that would be created: ${{ inputs.package }}@${{ steps.version.outputs.new-version }}"

      - name: Setup npm authentication (test mode)
        if: false
        run: |
          echo "::notice::In production, this would configure npm authentication"
          echo "::notice::Command: echo '//registry.npmjs.org/:_authToken=***' > ~/.npmrc"

      - name: Dry run - npm publish check
        working-directory: ${{ steps.package-info.outputs.folder }}
        run: |
          echo "::group::Package metadata"
          npm pack --dry-run
          echo "::endgroup::"
          
          echo "::notice::‚úÖ Package is ready for publishing (not actually publishing in test mode)"
          echo "::notice::Would run: npm publish --access public"

      - name: Check npm package status
        run: |
          CURRENT_NPM_VERSION=$(npm view ${{ inputs.package }} version 2>/dev/null || echo "not-published")
          echo "::notice::Current version on npm: $CURRENT_NPM_VERSION"
          echo "::notice::New version would be: ${{ steps.version.outputs.new-version }}"

      - name: Create Draft GitHub Release (TEST)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "test-${{ inputs.package }}@${{ steps.version.outputs.new-version }}"
          name: "[TEST] ${{ inputs.package }} v${{ steps.version.outputs.new-version }}"
          body: |
            ## üß™ TEST RELEASE - ${{ inputs.package }} v${{ steps.version.outputs.new-version }}
            
            **‚ö†Ô∏è THIS IS A TEST RELEASE - NOT PUBLISHED TO NPM**
            
            This is a dry run to test the release workflow. The package has been built and packaged,
            but has NOT been published to npm or committed to the repository.
            
            ### What was tested:
            - ‚úÖ Package dependency installation
            - ‚úÖ Building the package and dependencies
            - ‚úÖ Version bumping (from ${{ steps.version.outputs.old-version }} to ${{ steps.version.outputs.new-version }})
            - ‚úÖ CHANGELOG.md generation
            - ‚úÖ Tarball creation
            - ‚úÖ GitHub Release creation
            
            ### What was NOT done:
            - ‚ùå Git commit (changes not committed)
            - ‚ùå Git tag (only test tag created)
            - ‚ùå Push to repository
            - ‚ùå npm publish (package not published)
            
            ### Installation (if this were real)
            
            ```bash
            npm install ${{ inputs.package }}@${{ steps.version.outputs.new-version }}
            ```
            
            ### Package Archive
            
            The `.tgz` file below is the exact file that would be published to npm.
            You can download and inspect it to verify the contents.
            
            ### Next Steps
            
            If this test looks good:
            1. Delete this test release
            2. Run the real "Release Package" workflow
            3. The real workflow will commit, tag, and publish to npm
          files: |
            ${{ steps.pack.outputs.tarball-path }}
          draft: true
          prerelease: true
          generate_release_notes: false

      - name: Test Summary
        run: |
          echo "::notice title=Test Complete::‚úÖ Release workflow test completed successfully!"
          echo ""
          echo "### Test Results"
          echo "- Package: ${{ inputs.package }}"
          echo "- Old Version: ${{ steps.version.outputs.old-version }}"
          echo "- New Version: ${{ steps.version.outputs.new-version }}"
          echo "- Tarball: ${{ steps.pack.outputs.tarball }}"
          echo ""
          echo "### What to check:"
          echo "1. Go to Releases page and find the draft test release"
          echo "2. Download the .tgz file and verify its contents"
          echo "3. Review the generated CHANGELOG format"
          echo "4. If everything looks good, delete the test release and run the real workflow"
          echo ""
          echo "### Cleanup:"
          echo "- This test created a draft release with tag: test-${{ inputs.package }}@${{ steps.version.outputs.new-version }}"
          echo "- Delete it from the Releases page before running the real release"
          echo "- No commits were pushed to the repository"

